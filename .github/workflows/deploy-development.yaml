name: Auto deploy sofia-chat-backend-v2 development in VPS

on:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
      - 'index.html'
      - 'package.json'
      - 'public/**'
      - 'scripts/**'
      - 'src/**'
      - 'vite.config.js'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: npm install pg

      - name: Install pgvector on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_SSH_HOST }}
          username: ${{ secrets.DEV_SSH_USERNAME }}
          key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            sudo apt-get update && sudo apt-get install -y postgresql-16-pgvector

      - name: Deploy using ssh
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEVELOPMENT_SSH_HOST }}
          username: ${{ secrets.DEVELOPMENT_SSH_USERNAME }}
          key: ${{ secrets.DEVELOPMENT_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /root/repos/sofia-chat-backend-v2
            git pull origin main
            cat <<EOF > .env
            NODE_ENV=production
            LOG_LEVEL=production
            TYPEORM_HOST=${{ secrets.TYPEORM_HOST }}
            TYPEORM_PORT=${{ secrets.TYPEORM_PORT }}
            TYPEORM_USERNAME=${{ secrets.TYPEORM_USERNAME }}
            TYPEORM_PASSWORD=${{ secrets.TYPEORM_PASSWORD }}
            TYPEORM_DB_NAME=${{ secrets.TYPEORM_DB_NAME }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            JWT_SECRET_KEY_REFRESH=${{ secrets.JWT_SECRET_KEY_REFRESH }}
            NODEMAILER_HOST=${{ secrets.NODEMAILER_HOST }}
            NODEMAILER_PORT=${{ secrets.NODEMAILER_PORT }}
            NODEMAILER_USER=${{ secrets.NODEMAILER_USER }}
            NODEMAILER_PASS=${{ secrets.NODEMAILER_PASS }}
            NODEMAILER_FROM=${{ secrets.NODEMAILER_FROM }}
            URL_FILES=${{ secrets.URL_FILES }}
            URL_WSS=${{ secrets.URL_WSS }}
            URL_WEBHOOK_WA=${{ secrets.URL_WEBHOOK_WA }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            FACEBOOK_APP_ID=${{ secrets.FACEBOOK_APP_ID }}
            FACEBOOK_APP_SECRET=${{ secrets.FACEBOOK_APP_SECRET }}
            FACEBOOK_WEBHOOK_SECRET=${{ secrets.FACEBOOK_WEBHOOK_SECRET }}
            FACEBOOK_GRAPH_API=${{ secrets.FACEBOOK_GRAPH_API }}
            APP_URL=${{ secrets.APP_URL }}
            URL_FRONTEND=${{ secrets.URL_FRONTEND }}
            MAILGUN_API_KEY=${{ secrets.MAILGUN_API_KEY }}
            MAILGUN_DOMAIN=${{ secrets.MAILGUN_DOMAIN }}
            MAILGUN_FROM=${{ secrets.MAILGUN_FROM }}
            SLACK_CLIENT_ID=${{ secrets.SLACK_CLIENT_ID }}
            SLACK_CLIENT_SECRET=${{ secrets.SLACK_CLIENT_SECRET }}
            SLACK_REDIRECT_URI=${{ secrets.SLACK_REDIRECT_URI }}
            EOF
            node src/config/install-pgvector.js
            docker-compose build
            docker-compose down -v
            docker-compose up -d
